trigger:
- main

stages:

# - stage: SCA_Dependencies
#   displayName: "SCA Dependencies Analysis"
#   jobs:
#     - job: SCA
#       displayName: "Run SCA with Safety"
#       steps:
#         - template: sca/sca-safety.yml



# - stage: Build
#   displayName: "Build Stage"
#   dependsOn: SCA_Dependencies
#   jobs:
#     - job: BuildJob
#       displayName: "Build Python Project"
#       steps:
#         - task: UsePythonVersion@0
#           inputs:
#             versionSpec: '3.x'
#             addToPath: true

#         - script: |
#             python -m pip install --upgrade pip
#             pip install -r requirements.txt
#           displayName: 'Install dependencies'

#         - script: |
#             echo "Building the project"
#           displayName: 'Run Build'


- stage: Test
  displayName: "Test Stage"
  # dependsOn: Build
  jobs:
    - job: TestJob
      displayName: "Run Tests"
      steps:

        - task: DownloadSecureFile@1
          name: environment
          displayName: 'Download .env file'
          inputs:
            secureFile: '.env'

        - script: |
            echo "copying $(mySecureFile.secureFilePath) to $(Build.SourcesDirectory)"
            cp -f $(mySecureFile.secureFilePath) $(Build.SourcesDirectory)
          displayName: 'Forcibly Move Secure File to Build Sources Directory'

        - script: |
            pip install -r requirements.txt
          displayName: 'Install dependencies'

        - script: |
            echo "Running tests"
            pytest --junitxml=tests/test-results.xml
          displayName: 'Run Tests with pytest'

        - task: PublishTestResults@2
          inputs:
            testResultsFormat: 'JUnit'
            testResultsFiles: 'tests/test-results.xml'
            testRunTitle: 'Python Unit Tests'
